<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AKTIEN KI ANALYSE</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#121212;color:#e0f7f4;font-family:Arial;margin:0;padding:14px}
h1{text-align:center;font-size:1.4rem;margin:6px 0}
.subtitle{text-align:center;font-size:.85rem;color:#9fd3cc}

.controls{display:flex;flex-direction:column;gap:8px;margin:12px 0}
select,button{
  padding:10px;font-size:1rem;border-radius:8px;
  background:#1b1b1b;color:#e0f7f4;
  border:1px solid #00ccaa
}
button:disabled{opacity:.6}

.status{text-align:center;font-weight:bold;margin:6px 0;font-size:.9rem}

.progress-box{
  width:100%;background:#1a1a1a;border-radius:8px;
  overflow:hidden;margin:8px 0;display:none
}
.progress-bar{
  height:10px;width:0%;background:#00ccaa;
  transition:width .25s
}

canvas{
  width:100%!important;height:260px!important;
  background:#1a1a1a;border-radius:10px;padding:6px
}

.table-wrap{overflow-x:auto}
table{width:100%;min-width:520px;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #00ccaa;padding:6px;text-align:center;font-size:.85rem}

.buy{color:#00ff88;font-weight:bold}
.sell{color:#ff6666;font-weight:bold}
.hold{color:#ffaa55;font-weight:bold}

.footer{text-align:center;font-size:.75rem;color:#9fcfc8;margin-top:14px}
</style>
</head>

<body>

<h1>AKTIEN KI ANALYSE</h1>
<div class="subtitle">Stabil ¬∑ Kein Freeze ¬∑ Mobile</div>

<div class="controls">
  <select id="stock"></select>
  <button id="kiBtn">üß† KI: EIN</button>
  <button id="analyzeBtn">üìä Analyse starten</button>
</div>

<div class="progress-box" id="progressBox">
  <div class="progress-bar" id="progressBar"></div>
</div>

<div class="status" id="market"></div>
<div class="status" id="status">System bereit</div>

<canvas id="chart"></canvas>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Kurs</th>
  <th>Prognose</th>
  <th>Signal</th>
  <th>Stabilit√§t</th>
  <th>Pattern</th>
</tr>
</thead>
<tbody id="result"></tbody>
</table>
</div>

<div class="footer">Keine Anlageberatung</div>

<script>
"use strict";

/* ================= KONFIG ================= */
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
let KI=true, chart=null, isAnalyzing=false;

/* ================= AKTIEN ================= */
const STOCKS=[
["AAPL","Apple"],["MSFT","Microsoft"],["NVDA","NVIDIA"],
["AMZN","Amazon"],["TSLA","Tesla"],["GOOGL","Alphabet"],
["META","Meta"],["NFLX","Netflix"],
["NESN.SW","Nestl√©"],["ROG.SW","Roche"],["NOVN.SW","Novartis"]
];

const stockSel=document.getElementById("stock");
STOCKS.forEach(s=>{
  const o=document.createElement("option");
  o.value=s[0];
  o.textContent=`${s[0]} ‚Äì ${s[1]}`;
  stockSel.appendChild(o);
});

/* ================= BUTTONS ================= */
kiBtn.onclick=()=>{
  KI=!KI;
  kiBtn.textContent="üß† KI: "+(KI?"EIN":"AUS");
};

analyzeBtn.onclick=()=>{
  if(!isAnalyzing) analyze();
};

/* ================= UI ================= */
function setProgress(p){
  progressBox.style.display="block";
  progressBar.style.width=p+"%";
}
function resetProgress(){
  progressBar.style.width="0%";
  progressBox.style.display="none";
}

/* ================= MARKTSTATUS ================= */
function updateMarket(){
  const d=new Date().getDay();
  market.textContent =
    (d===0||d===6)
    ?"üî¥ B√∂rse geschlossen ‚Äì letzte Daten"
    :"üü¢ B√∂rse ge√∂ffnet / letzte Kurse";
}

/* ================= DATEN ================= */
async function fetchOHLC(symbol){
  const now=Math.floor(Date.now()/1000);
  const from=now-300*86400;
  try{
    const r=await fetch(
      `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`
    );
    const d=await r.json();
    if(d.s==="ok"&&d.c?.length){
      localStorage.setItem("CACHE_"+symbol,JSON.stringify(d));
      return d;
    }
  }catch{}
  const cache=localStorage.getItem("CACHE_"+symbol);
  return cache?JSON.parse(cache):null;
}

/* ================= PATTERN ================= */
function pattern(d){
  const i=d.c.length-1;
  if(i<1) return {score:0,p:["‚Äì"]};
  let score=0,p=[];
  const body=Math.abs(d.c[i]-d.o[i]);
  const range=d.h[i]-d.l[i];
  if(body<range*0.1){p.push("Doji");score++;}
  if(d.c[i]>d.o[i]&&d.c[i-1]<d.o[i-1]){p.push("Bullish");score+=3;}
  if(d.o[i]>d.c[i]&&d.c[i-1]>d.o[i-1]){p.push("Bearish");score-=3;}
  return {score,p};
}

/* ================= CHART ================= */
function draw(prices,forecast){
  if(chart) chart.destroy();
  chart=new Chart(chartEl,{
    type:"line",
    data:{
      labels:[...prices.map((_,i)=>i+1),...forecast.map((_,i)=>"F"+(i+1))],
      datasets:[
        {label:"Kurs",data:[...prices,...Array(forecast.length).fill(null)]},
        {label:"Prognose",data:[...Array(prices.length).fill(null),...forecast]}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

/* ================= FREEZE-SICHERE ANALYSE ================= */
async function analyze(){
  if(isAnalyzing) return;
  isAnalyzing=true;
  analyzeBtn.disabled=true;

  const idle=()=>new Promise(r=>setTimeout(r,0));

  try{
    status.textContent="Analyse startet‚Ä¶";
    setProgress(5);
    await idle();

    updateMarket();
    setProgress(15);
    status.textContent="Lade Marktdaten‚Ä¶";
    await idle();

    const d=await fetchOHLC(stockSel.value);
    if(!d||!d.c||d.c.length===0){
      status.textContent="‚ùå Keine Marktdaten verf√ºgbar";
      return;
    }

    setProgress(40);
    status.textContent="Analysiere Kurse‚Ä¶";
    await idle();

    const prices=d.c.slice(-30);
    const last=prices.at(-1);

    const r=pattern(d);

    setProgress(65);
    status.textContent="Berechne Prognose‚Ä¶";
    await idle();

    let factor=0.002;
    if(r.score>2) factor=0.008;
    if(r.score<0) factor=-0.006;
    if(!KI) factor=0;

    const forecast=[1,2,3,4,5].map(i=>last*(1+factor*i));

    setProgress(85);
    draw(prices,forecast);
    await idle();

    const diff=(forecast.at(-1)-last)/last;
    const signal=diff>0.05?"KAUFEN":diff<-0.05?"VERKAUFEN":"HALTEN";
    const cls=signal==="KAUFEN"?"buy":signal==="VERKAUFEN"?"sell":"hold";

    result.innerHTML=`
      <tr>
        <td>${last.toFixed(2)}</td>
        <td>${forecast.at(-1).toFixed(2)}</td>
        <td class="${cls}">${signal}</td>
        <td>${Math.max(25,100-Math.abs(diff)*600).toFixed(0)}/100</td>
        <td>${r.p.join(", ")}</td>
      </tr>`;

    setProgress(100);
    status.textContent="‚úÖ Analyse abgeschlossen";

  }catch(e){
    console.error(e);
    status.textContent="‚ùå Analysefehler (abgefangen)";
  }finally{
    setTimeout(resetProgress,600);
    analyzeBtn.disabled=false;
    isAnalyzing=false;
  }
}

updateMarket();
</script>

</body>
</html>
