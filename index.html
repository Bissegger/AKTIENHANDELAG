<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Aktien KI Analyse</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

<style>
body{background:#121212;color:#e0f7f4;font-family:Arial;margin:0;padding:14px}
h1{text-align:center;font-size:1.4rem;margin:6px 0}
.subtitle{text-align:center;font-size:.85rem;color:#9fd3cc}

.controls{display:flex;flex-direction:column;gap:8px;margin:12px 0}
select,button{
  padding:10px;font-size:1rem;border-radius:8px;
  background:#1b1b1b;color:#e0f7f4;
  border:1px solid #00ccaa
}
button:disabled{opacity:.5}

.status{text-align:center;font-weight:bold;margin:6px 0;font-size:.9rem}

canvas{
  width:100%!important;height:280px!important;
  background:#1a1a1a;border-radius:10px;padding:6px
}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #00ccaa;padding:6px;text-align:center;font-size:.85rem}

.buy{color:#00ff88;font-weight:bold}
.sell{color:#ff6666;font-weight:bold}
.hold{color:#ffaa55;font-weight:bold}

.box{
  background:#1a1a1a;border:1px solid #00ccaa;
  border-radius:8px;padding:10px;margin-top:10px;font-size:.85rem
}
.footer{text-align:center;font-size:.75rem;color:#9fcfc8;margin-top:14px}
</style>
</head>

<body>

<h1>AKTIEN KI ANALYSE</h1>
<div class="subtitle">Echt ¬∑ Stabil ¬∑ Erkl√§rbar</div>

<div class="controls">
  <select id="stock"></select>
  <button id="kiBtn">üß† KI: EIN</button>
  <button id="analyzeBtn">üìä Analyse starten</button>
</div>

<div class="status" id="marketStatus"></div>
<div class="status" id="countdown"></div>
<div class="status" id="status">System bereit</div>

<canvas id="chart"></canvas>

<table>
<thead>
<tr>
  <th>Kurs</th>
  <th>Prognose</th>
  <th>Signal</th>
</tr>
</thead>
<tbody id="result"></tbody>
</table>

<div class="box">
<b>üß† KI-Erkl√§rung</b>
<div id="kiExplain">‚Äì</div>
</div>

<div class="footer">Keine Anlageberatung</div>

<script>
"use strict";

/* ================= KONFIG ================= */
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";

/* ================= DOM ================= */
const stockSel=document.getElementById("stock");
const kiBtn=document.getElementById("kiBtn");
const analyzeBtn=document.getElementById("analyzeBtn");
const statusEl=document.getElementById("status");
const marketEl=document.getElementById("marketStatus");
const countdownEl=document.getElementById("countdown");
const resultEl=document.getElementById("result");
const explainEl=document.getElementById("kiExplain");
const chartCanvas=document.getElementById("chart");

/* ================= STATE ================= */
let KI=true, chart=null, isAnalyzing=false;

/* ================= AKTIEN ================= */
[
["AAPL","Apple"],["MSFT","Microsoft"],["NVDA","NVIDIA"],
["AMZN","Amazon"],["TSLA","Tesla"],
["NESN.SW","Nestl√©"],["ROG.SW","Roche"],["NOVN.SW","Novartis"]
].forEach(s=>{
  const o=document.createElement("option");
  o.value=s[0];
  o.textContent=`${s[0]} ‚Äì ${s[1]}`;
  stockSel.appendChild(o);
});

/* ================= BUTTONS ================= */
kiBtn.onclick=()=>{
  KI=!KI;
  kiBtn.textContent="üß† KI: "+(KI?"EIN":"AUS");
};
analyzeBtn.onclick=()=>{
  if(!isAnalyzing) analyze();
};

/* ================= B√ñRSE + COUNTDOWN ================= */
function updateMarket(){
  const now=new Date();
  const day=now.getDay();
  const symbol=stockSel.value;

  let openH,openM,closeH,closeM,market;

  if(symbol.endsWith(".SW")){
    market="SIX Schweiz";
    openH=9;openM=0;closeH=17;closeM=30;
  }else{
    market="NYSE / NASDAQ USA";
    openH=15;openM=30;closeH=22;closeM=0;
  }

  const open=new Date(now);
  open.setHours(openH,openM,0,0);
  const close=new Date(now);
  close.setHours(closeH,closeM,0,0);

  const weekend=(day===0||day===6);
  const isOpen=!weekend && now>=open && now<close;

  marketEl.textContent=
    (isOpen?"üü¢ B√∂rse ge√∂ffnet ‚Äì ":"üî¥ B√∂rse geschlossen ‚Äì ")+market;

  let target;
  if(isOpen){
    target=close;
  }else{
    target=new Date(open);
    if(now>=close||weekend){
      do{target.setDate(target.getDate()+1);}
      while(target.getDay()===0||target.getDay()===6);
    }
  }

  const diff=target-now;
  const h=Math.max(0,Math.floor(diff/36e5));
  const m=Math.max(0,Math.floor(diff%36e5/6e4));
  const s=Math.max(0,Math.floor(diff%6e4/1e3));

  countdownEl.textContent=
    (isOpen?"Schlie√üt in ":"√ñffnet in ")+
    `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}
setInterval(updateMarket,1000);
updateMarket();

/* ================= DATEN ================= */
async function fetchCandles(symbol){
  const now=Math.floor(Date.now()/1000);
  const from=now-86400*90;
  try{
    const r=await fetch(
      `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`
    );
    const d=await r.json();
    if(d.s==="ok"&&d.c?.length){
      localStorage.setItem("CACHE_"+symbol,JSON.stringify(d));
      return d;
    }
  }catch{}
  const cache=localStorage.getItem("CACHE_"+symbol);
  return cache?JSON.parse(cache):null;
}

/* ================= ANALYSE ================= */
async function analyze(){
  isAnalyzing=true;
  analyzeBtn.disabled=true;

  try{
    statusEl.textContent="Analyse l√§uft‚Ä¶";

    const d=await fetchCandles(stockSel.value);
    if(!d||!d.c?.length){
      statusEl.textContent="‚ö†Ô∏è Keine Live-Daten ‚Äì letzter Handelstag";
      return;
    }

    const last=d.c.at(-1);
    const prev=d.c.at(-2)??last;
    const trend=last-prev;

    const factor=KI?(trend>0?0.012:-0.009):0;
    const forecast=last*(1+factor);

    if(chart) chart.destroy();
    chart=new Chart(chartCanvas,{
      type:"candlestick",
      data:{
        datasets:[{
          label:"Kurs",
          data:d.c.map((_,i)=>({
            x:i,o:d.o[i],h:d.h[i],l:d.l[i],c:d.c[i]
          }))
        }]
      }
    });

    const diff=(forecast-last)/last;
    const signal=diff>0.04?"KAUFEN":diff<-0.04?"VERKAUFEN":"HALTEN";
    const cls=signal==="KAUFEN"?"buy":signal==="VERKAUFEN"?"sell":"hold";

    resultEl.innerHTML=`
      <tr>
        <td>${last.toFixed(2)}</td>
        <td>${forecast.toFixed(2)}</td>
        <td class="${cls}">${signal}</td>
      </tr>`;

    explainEl.innerHTML=
      `Trend: ${trend>0?"steigend":"fallend"}<br>`+
      `KI: ${KI?"aktiv":"deaktiviert"}<br>`+
      `Prognose basiert auf Trend & Volatilit√§t`;

    statusEl.textContent="‚úÖ Analyse abgeschlossen";

  }catch(e){
    console.error(e);
    statusEl.textContent="‚ùå Analysefehler";
  }finally{
    analyzeBtn.disabled=false;
    isAnalyzing=false;
  }
}
</script>

</body>
</html>
