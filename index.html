<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>KI Aktienanalyse PRO</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>

<style>
body{
  background:#0f131a;
  color:#e6f7f4;
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  padding:16px;
}
h1{text-align:center}
.controls{text-align:center;margin-bottom:10px}
select,button{
  background:#161c26;
  color:#e6f7f4;
  border:1px solid #00c2a8;
  padding:6px 10px;
  border-radius:6px;
}
button:hover{background:#00c2a8;color:#000}
.status{text-align:center;font-weight:bold;margin:10px}
.buy{color:#00ff88}
.sell{color:#ff6666}
.hold{color:#ffaa55}
canvas{max-width:1200px;margin:auto;display:block}
</style>
</head>

<body>

<h1>ðŸ“ˆ KI Aktienanalyse PRO</h1>

<div class="controls">
<select id="stock">
  <option value="AAPL">Apple</option>
  <option value="MSFT">Microsoft</option>
  <option value="NVDA">NVIDIA</option>
  <option value="TSLA">Tesla</option>
</select>
<button onclick="analyze()">Analyse starten</button>
</div>

<div class="status" id="status">Bereit</div>
<canvas id="chart"></canvas>

<script>
const API_KEY="d5ohqjhr01qjast6qrjgd5ohqjhr01qjast6qrk0";
const WINDOW=20;
let chart;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ INDICATORS â”€â”€â”€â”€â”€â”€â”€â”€â”€
function EMA(data,p){
  const k=2/(p+1); let e=data[0];
  for(let i=1;i<data.length;i++) e=data[i]*k+e*(1-k);
  return e;
}
function RSI(prices){
  let g=0,l=0;
  for(let i=prices.length-14;i<prices.length-1;i++){
    const d=prices[i+1]-prices[i];
    d>0?g+=d:l-=d;
  }
  return 100-(100/(1+(g/(l||1))));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPrices(symbol){
  const now=Math.floor(Date.now()/1000);
  const from=now-90*86400;
  const res=await fetch(
    `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${now}&token=${API_KEY}`
  );
  const d=await res.json();
  if(d.s!=="ok") throw new Error("Keine Marktdaten");
  return d.c;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ KI â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function predict(prices){
  const min=Math.min(...prices);
  const max=Math.max(...prices);
  const range=max-min||1;
  const norm=prices.map(p=>(p-min)/range);

  const X=[],Y=[];
  for(let i=0;i<norm.length-WINDOW;i++){
    X.push(norm.slice(i,i+WINDOW).map(v=>[v]));
    Y.push(norm[i+WINDOW]);
  }

  const xs=tf.tensor3d(X);
  const ys=tf.tensor2d(Y,[Y.length,1]);

  const model=tf.sequential();
  model.add(tf.layers.lstm({units:64,inputShape:[WINDOW,1]}));
  model.add(tf.layers.dense({units:1}));
  model.compile({optimizer:"adam",loss:"meanSquaredError"});
  await model.fit(xs,ys,{epochs:35,verbose:0});

  let win=norm.slice(-WINDOW);
  const forecast=[];
  for(let i=0;i<10;i++){
    const p=model.predict(tf.tensor3d([win.map(v=>[v])])).dataSync()[0];
    win.shift(); win.push(p);
    forecast.push(p*range+min);
  }
  return forecast;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyze(){
  try{
    document.getElementById("status").textContent="Analyse lÃ¤uftâ€¦";
    const symbol=document.getElementById("stock").value;
    const prices=await loadPrices(symbol);
    const forecast=await predict(prices);

    const last=prices.at(-1);
    const pred=forecast.at(-1);
    const ema9=EMA(prices,9);
    const ema21=EMA(prices,21);
    const rsi=RSI(prices);

    let signal="HALTEN",cls="hold";
    if(pred>last*1.05 && ema9>ema21 && rsi<70){signal="KAUFEN";cls="buy";}
    if(pred<last*0.95 && ema9<ema21 && rsi>30){signal="VERKAUFEN";cls="sell";}

    document.getElementById("status").innerHTML=
      `Signal: <span class="${cls}">${signal}</span>
       | RSI: ${rsi.toFixed(1)}
       | Trend: ${ema9>ema21?"AufwÃ¤rts":"AbwÃ¤rts"}`;

    if(chart) chart.destroy();
    chart=new Chart(document.getElementById("chart"),{
      type:"line",
      data:{
        labels:[
          ...prices.map((_,i)=>"T"+i),
          ...forecast.map((_,i)=>"F"+i)
        ],
        datasets:[
          {label:"Kurs",data:[...prices,...Array(10).fill(null)],borderColor:"#00c2a8"},
          {label:"KI Prognose",data:[...Array(prices.length).fill(null),...forecast],borderColor:"#ffaa55"}
        ]
      }
    });
  }catch(e){
    document.getElementById("status").textContent="Fehler: "+e.message;
  }
}
</script>
</body>
</html>
